<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.luxuryadmin.mapper.shp.ShpShopMapper">
    <resultMap id="BaseResultMap" type="com.luxuryadmin.entity.shp.ShpShop">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="number" jdbcType="VARCHAR" property="number"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="address" jdbcType="VARCHAR" property="address"/>
        <result column="desc" jdbcType="VARCHAR" property="desc"/>
        <result column="contact" jdbcType="VARCHAR" property="contact"/>
        <result column="head_img_url" jdbcType="VARCHAR" property="headImgUrl"/>
        <result column="fk_shp_user_id" jdbcType="INTEGER" property="fkShpUserId"/>
        <result column="fk_shp_state_code" jdbcType="INTEGER" property="fkShpStateCode"/>
        <result column="fk_shp_attribute_code" jdbcType="INTEGER" property="fkShpAttributeCode"/>
        <result column="pay_month" jdbcType="INTEGER" property="payMonth"/>
        <result column="try_start_time" jdbcType="TIMESTAMP" property="tryStartTime"/>
        <result column="try_end_time" jdbcType="TIMESTAMP" property="tryEndTime"/>
        <result column="pay_start_time" jdbcType="TIMESTAMP" property="payStartTime"/>
        <result column="pay_end_time" jdbcType="TIMESTAMP" property="payEndTime"/>
        <result column="pay_end_time_old" jdbcType="TIMESTAMP" property="payEndTimeOld"/>
        <result column="admin_add_time" jdbcType="TIMESTAMP" property="adminAddTime"/>
        <result column="total_hours" jdbcType="DECIMAL" property="totalHours"/>
        <result column="total_month" jdbcType="INTEGER" property="totalMonth"/>
        <result column="is_member" jdbcType="VARCHAR" property="isMember"/>
        <result column="mini_program_cover_img_url" jdbcType="VARCHAR" property="miniProgramCoverImgUrl"/>
        <result column="insert_time" jdbcType="TIMESTAMP" property="insertTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="insert_admin" jdbcType="INTEGER" property="insertAdmin"/>
        <result column="update_admin" jdbcType="INTEGER" property="updateAdmin"/>
        <result column="versions" jdbcType="INTEGER" property="versions"/>
        <result column="del" jdbcType="CHAR" property="del"/>
        <result column="remark" jdbcType="VARCHAR" property="remark"/>
        <result column="cover_img_url" jdbcType="VARCHAR" property="coverImgUrl"/>
        <result column="validate_state" jdbcType="CHAR" property="validateState"/>
        <result column="member_state" jdbcType="INTEGER" property="memberState"/>
        <result column="fk_sys_job_wx_id" jdbcType="INTEGER" property="fkSysJobWxId"/>
    </resultMap>
    <sql id="Base_Column_List">
    id, number, name, address, `desc`, contact, cover_img_url,head_img_url, fk_shp_user_id,member_state,
    fk_shp_state_code, fk_shp_attribute_code, validate_state, pay_month, try_start_time,
    try_end_time, pay_start_time, pay_end_time, pay_end_time_old, admin_add_time,total_hours, total_month, is_member,mini_program_cover_img_url,
    insert_time, update_time, insert_admin, update_admin, versions, del, remark,fk_sys_job_wx_id
  </sql>
    <select id="getObjectById" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from shp_shop
        where id = #{id,jdbcType=INTEGER}
    </select>

    <select id="listShpShopBaseInfo" resultType="com.luxuryadmin.vo.shp.VoShopBase">
        SELECT
          shop.id 'shopId',
          shop.`number` 'shopNumber',
          shop.`name` 'shopName',
          shop.`head_img_url` 'shopHeadImgUrl',
          (SELECT name FROM shp_user_type WHERE id = shpRef.`fk_shp_user_type_id`) 'type',
          shop.insert_time 'insertTime',
          shop.member_state 'memberState'
        FROM
          shp_user_shop_ref shpRef
          RIGHT JOIN shp_shop shop
            ON shpRef.`fk_shp_shop_id` = shop.`id`
        WHERE shpRef.fk_shp_user_id = #{userId}
        AND shpRef.state = 1
        AND shpRef.del = '0'
        AND shop.fk_shp_state_code != -99
    </select>

    <select id="getShopCount" resultType="Integer">
        SELECT
        count(*)
        FROM
        shp_user_shop_ref shpRef
        RIGHT JOIN shp_shop shop
        ON shpRef.`fk_shp_shop_id` = shop.`id`
        WHERE shpRef.fk_shp_user_id = #{userId}
        AND shpRef.state = 1
        AND shpRef.del = '0'
        AND shop.fk_shp_state_code != -99
    </select>
    <select id="getVoUserShopBaseByShopId" resultType="com.luxuryadmin.vo.shp.VoUserShopBase">
        SELECT
          shop.name 'shopName',
          shop.`address` 'shopAddress',
          shop.`number` 'shopNumber',
          shop.`head_img_url` 'shopHeadImgUrl',
          shop.cover_img_url 'coverImgUrl',
          shop.mini_program_cover_img_url 'miniProgramCoverImgUrl',
          shop.validate_state 'validateState',
          det.`province` 'shopProvince',
          det.`city` 'shopCity',
          u.`phone` 'shopPhone',
          u.`nickname` 'shopkeeper'
        FROM
          shp_shop shop
          LEFT JOIN shp_detail det
            ON shop.`id` = det.`fk_shp_shop_id`
          left join shp_user u
            on shop.`fk_shp_user_id` = u.`id`
            AND shop.del = '0'
        WHERE shop.id = #{shopId}
    </select>

    <!--根据店铺id获取店铺编号-->
    <select id="getShopNumberAndShopNameByShopId" resultType="java.util.Map">
        SELECT
            shop.`number` 'shopNumber',
            shop.name 'shopName',
            shop.is_member 'isMember',
            shop.mini_program_cover_img_url 'miniProgramCoverImgUrl',
            shop.try_end_time 'tryEndTime',
            shop.pay_end_time 'payEndTime',
            shop.member_state 'memberState'
        FROM shp_shop shop WHERE shop.`id` = #{shopId}
    </select>

    <!--获取订单凭证所需的店铺信息;-->
    <select id="getShopInfoToOrdReceipt" resultType="com.luxuryadmin.vo.shp.VoUserShopBase">
        SELECT
          shop.name 'shopName',
          CONCAT(
            det.`province`,
            det.`city`,
            shop.address
          ) 'shopAddress',
          shop.contact 'phone'
        FROM
          shp_shop shop
          LEFT JOIN shp_detail det
            ON shop.`id` = det.`fk_shp_shop_id`
        WHERE shop.id = #{shopId}
    </select>
    <!--根据店铺编号获取分享店铺的信息-->
    <select id="getShareShopInfoByShopNumber" resultType="com.luxuryadmin.vo.shp.VoUserShopBase">
        SELECT
          shop.id 'shopId',
          shop.name 'shopName',
          CONCAT(
            det.`province`,
            det.`city`,
            shop.address
          ) 'shopAddress',
          shop.`number` 'shopNumber',
          shop.head_img_url 'shopHeadImgUrl'
        FROM
          shp_shop shop
          LEFT JOIN shp_detail det
            ON shop.`id` = det.`fk_shp_shop_id`
        where shop.`number` = #{shopNumber}
    </select>
    <select id="getShopIdByShopNumber" resultType="java.lang.Integer">
        SELECT shop.`id` FROM shp_shop shop WHERE shop.`number` = #{shopNumber}
    </select>

    <!--获取所有店铺的id和店主的userId-->
    <select id="listAllShopIdAndUserId" resultType="com.luxuryadmin.vo.shp.VoUserShopBase">
        select
          id 'shopId',
          fk_shp_user_id 'userId'
        from
          shp_shop
        where del = '0'
        and
          fk_shp_state_code >= 0
    </select>
    <!-- 条件查询店铺列表 -->
    <select id="listShpShop" parameterType="com.luxuryadmin.param.shp.ParamShpShop"
            resultType="com.luxuryadmin.vo.shp.VoShpShop">
        SELECT
        ss.id AS id,
        ss.is_member AS member,
        ss.number AS number,
        ss.name AS NAME,
        ss.address AS address,
        ss.desc AS `desc`,
        ss.contact AS contact,
        ss.cover_img_url AS coverImgUrl,
        ss.head_img_url AS headImgUrl,
        su.id AS fkShpUserId,
        ss.fk_shp_state_code AS fkShpStateCode,
        ss.fk_shp_attribute_code AS fkShpAttributeCode,
        ss.validate_state AS validateState,
        ss.pay_month AS payMonth,
        ss.try_start_time AS tryStartTime,
        ss.try_end_time AS tryEndTime,
        ss.pay_start_time AS payStartTime,
        ss.pay_end_time AS payEndTime,
        ss.admin_add_time AS adminAddTime,
        ss.total_month AS totalMonth,
        ss.insert_time AS insertTime,
        ss.update_time AS updateTime,
        ss.insert_admin AS insertAdmin,
        ss.update_admin AS updateAdmin,
        ss.versions AS versions,
        ss.del AS del,
        ss.remark AS remark,
        IFNULL(wx.nickname ,'无')AS jobWx,
        sd.province AS province,
        sd.city AS city,
        su.number AS userNumber,
        (SELECT COUNT(ref.id) FROM shp_user_shop_ref ref WHERE ref.fk_shp_shop_id = ss.id AND ref.state = 1)
        'employeeNum'
        FROM
        shp_detail sd,
        shp_shop ss
        LEFT JOIN shp_user su
        ON su.id = ss.fk_shp_user_id
        LEFT JOIN sys_job_wx wx ON wx.id = ss.`fk_sys_job_wx_id`
        WHERE (1 = 1)
        AND ss.id = sd.fk_shp_shop_id
        <if test="number != null">
            and ss.number = #{number}
        </if>
        <if test="phone != null">
            and ss.contact = #{phone}
        </if>
        <if test="name != null">
            and ss.name like CONCAT('%',#{name},'%')
        </if>
        <if test="validateState != null">
            and ss.validate_state = #{validateState}
        </if>
        <if test="insertTimeStart != null">
            and ss.insert_time >= #{insertTimeStart}
        </if>
        <if test="insertTimeEnd != null">
            and #{insertTimeEnd} >= ss.insert_time
        </if>
        <if test="member != null">
            and ss.is_member = #{member}
        </if>
        <if test="sysJobWxId != null">
            and ss.fk_sys_job_wx_id = #{sysJobWxId}
        </if>
        and ss.del = '0'
        order by
        <if test="member != null and member == 'yes'">
            ss.pay_start_time desc,
        </if>
                 ss.insert_time desc
    </select>

    <!--根据经营者的手机号和店铺编号查找店铺id-->
    <select id="getShopIdByPhoneAndShopNumber" resultType="java.lang.Integer">
        SELECT shop.`id` FROM shp_shop shop WHERE shop.`number` = #{shopNumber} and shop.contact = #{phone}
    </select>
    <!--根据经营者的手机号获取店铺编号-->
    <select id="getShopNumberByPhone" resultType="java.util.Map">
        SELECT shop.name,shop.number FROM shp_shop shop WHERE shop.contact = #{phone} AND shop.fk_shp_state_code >=10
    </select>
    <!-- 根据[店铺ID]获取[经营者用户ID] -->
    <select id="getBossUserIdByShopId" resultType="java.lang.Integer">
         select
          fk_shp_user_id
        from
          shp_shop
        where
          id = #{shopId}
        and
          del = '0'
    </select>

    <select id="queryShpShopIdList" resultType="java.lang.Integer">
        select
          id
        from
          shp_shop
        where
          del = '0'
        and
          fk_shp_state_code >= 0
    </select>

    <!-- 根据统计日期统计注册店铺数 -->
    <select id="countRegShopNumByCountDate" resultType="java.lang.Integer">
        select count(1) from shp_shop where DATE(insert_time) = DATE(#{countDate})
    </select>

    <!--获取所有店铺, 用于初始化会员时间,只获取id,is_member,insert_time字段-->
    <select id="listShpShopForInitVip" resultType="com.luxuryadmin.entity.shp.ShpShop">
        SELECT
          id,
          is_member 'isMember',
          insert_time 'insertTime',
          member_state 'memberState',
          try_end_time 'tryEndTime',
          pay_end_time 'payEndTime'
        FROM
          shp_shop
        WHERE fk_shp_state_code >= 0
    </select>

    <!--获取所有会员时间过期的会员店铺;-->
    <select id="listVipExpireShop" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from shp_shop
        where
        (member_state!=0 and #{expireTime}>=pay_end_time)
        or
        (member_state=1 and #{expireTime}>=try_end_time)
    </select>

    <delete id="deleteObject" parameterType="java.lang.Integer">
    delete from shp_shop
    where id = #{id,jdbcType=INTEGER}
  </delete>

    <insert id="saveObject" parameterType="com.luxuryadmin.entity.shp.ShpShop" useGeneratedKeys="true" keyProperty="id">
        insert into shp_shop
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="number != null">
                number,
            </if>
            <if test="name != null">
                name,
            </if>
            <if test="address != null">
                address,
            </if>
            <if test="desc != null">
                desc,
            </if>
            <if test="contact != null">
                contact,
            </if>
            <if test="coverImgUrl != null">
                cover_img_url,
            </if>
            <if test="headImgUrl != null">
                head_img_url,
            </if>
            <if test="fkShpUserId != null">
                fk_shp_user_id,
            </if>
            <if test="fkShpStateCode != null">
                fk_shp_state_code,
            </if>
            <if test="fkShpAttributeCode != null">
                fk_shp_attribute_code,
            </if>
            <if test="validateState != null">
                valiadate_state,
            </if>
            <if test="payMonth != null">
                pay_month,
            </if>
            <if test="tryStartTime != null">
                try_start_time,
            </if>
            <if test="tryEndTime != null">
                try_end_time,
            </if>
            <if test="payStartTime != null">
                pay_start_time,
            </if>
            <if test="payEndTime != null">
                pay_end_time,
            </if>
            <if test="adminAddTime != null">
                admin_add_time,
            </if>
            <if test="totalHours != null">
                total_hours,
            </if>
            <if test="totalMonth != null">
                total_month,
            </if>
            <if test="isMember != null">
                is_member,
            </if>
            <if test="miniProgramCoverImgUrl != null">
                mini_program_cover_img_url,
            </if>
            <if test="insertTime != null">
                insert_time,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
            <if test="insertAdmin != null">
                insert_admin,
            </if>
            <if test="updateAdmin != null">
                update_admin,
            </if>
            <if test="versions != null">
                versions,
            </if>
            <if test="del != null">
                del,
            </if>
            <if test="remark != null">
                remark,
            </if>
            <if test="memberState != null">
                member_state,
            </if>
            <if test="fkSysJobWxId != null">
                fk_sys_job_wx_id,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="number != null">
                #{number,jdbcType=VARCHAR},
            </if>
            <if test="name != null">
                #{name,jdbcType=VARCHAR},
            </if>
            <if test="address != null">
                #{address,jdbcType=VARCHAR},
            </if>
            <if test="desc != null">
                #{desc,jdbcType=VARCHAR},
            </if>
            <if test="contact != null">
                #{contact,jdbcType=VARCHAR},
            </if>
            <if test="coverImgUrl != null">
                #{coverImgUrl,jdbcType=VARCHAR},
            </if>
            <if test="headImgUrl != null">
                #{headImgUrl,jdbcType=VARCHAR},
            </if>
            <if test="fkShpUserId != null">
                #{fkShpUserId,jdbcType=INTEGER},
            </if>
            <if test="fkShpStateCode != null">
                #{fkShpStateCode,jdbcType=INTEGER},
            </if>
            <if test="fkShpAttributeCode != null">
                #{fkShpAttributeCode,jdbcType=INTEGER},
            </if>
            <if test="validateState != null">
                #{validateState,jdbcType=CHAR},
            </if>
            <if test="payMonth != null">
                #{payMonth,jdbcType=INTEGER},
            </if>
            <if test="tryStartTime != null">
                #{tryStartTime,jdbcType=TIMESTAMP},
            </if>
            <if test="tryEndTime != null">
                #{tryEndTime,jdbcType=TIMESTAMP},
            </if>
            <if test="payStartTime != null">
                #{payStartTime,jdbcType=TIMESTAMP},
            </if>
            <if test="payEndTime != null">
                #{payEndTime,jdbcType=TIMESTAMP},
            </if>
            <if test="adminAddTime != null">
                #{adminAddTime,jdbcType=TIMESTAMP},
            </if>
            <if test="totalHours != null">
                #{totalHours,jdbcType=DECIMAL},
            </if>
            <if test="totalMonth != null">
                #{totalMonth,jdbcType=INTEGER},
            </if>
            <if test="isMember != null">
                #{isMember,jdbcType=VARCHAR},
            </if>
            <if test="miniProgramCoverImgUrl != null">
                #{miniProgramCoverImgUrl,jdbcType=VARCHAR},
            </if>
            <if test="insertTime != null">
                #{insertTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="insertAdmin != null">
                #{insertAdmin,jdbcType=INTEGER},
            </if>
            <if test="updateAdmin != null">
                #{updateAdmin,jdbcType=INTEGER},
            </if>
            <if test="versions != null">
                #{versions,jdbcType=INTEGER},
            </if>
            <if test="del != null">
                #{del,jdbcType=CHAR},
            </if>
            <if test="remark != null">
                #{remark,jdbcType=VARCHAR},
            </if>
            <if test="memberState != null">
                #{memberState,jdbcType=INTEGER},
            </if>
            <if test="fkSysJobWxId != null">
                #{fkSysJobWxId,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>
    <update id="updateObject" parameterType="com.luxuryadmin.entity.shp.ShpShop">
        update shp_shop
        <set>
            <if test="number != null">
                `number` = #{number,jdbcType=VARCHAR},
            </if>
            <if test="name != null">
                `name` = #{name,jdbcType=VARCHAR},
            </if>
            <if test="address != null">
                address = #{address,jdbcType=VARCHAR},
            </if>
            <if test="desc != null">
                `desc` = #{desc,jdbcType=VARCHAR},
            </if>
            <if test="contact != null">
                contact = #{contact,jdbcType=VARCHAR},
            </if>
            <if test="coverImgUrl != null">
                cover_img_url = #{coverImgUrl,jdbcType=VARCHAR},
            </if>
            <if test="headImgUrl != null">
                head_img_url = #{headImgUrl,jdbcType=VARCHAR},
            </if>
            <if test="fkShpUserId != null">
                fk_shp_user_id = #{fkShpUserId,jdbcType=INTEGER},
            </if>
            <if test="fkShpStateCode != null">
                fk_shp_state_code = #{fkShpStateCode,jdbcType=INTEGER},
            </if>
            <if test="fkShpAttributeCode != null">
                fk_shp_attribute_code = #{fkShpAttributeCode,jdbcType=INTEGER},
            </if>
            <if test="validateState != null">
                validate_state = #{validateState,jdbcType=CHAR},
            </if>
            <if test="payMonth != null">
                pay_month = #{payMonth,jdbcType=INTEGER},
            </if>
            <if test="tryStartTime != null">
                try_start_time = #{tryStartTime,jdbcType=TIMESTAMP},
            </if>
            <if test="tryEndTime != null">
                try_end_time = #{tryEndTime,jdbcType=TIMESTAMP},
            </if>
            <if test="payStartTime != null">
                pay_start_time = #{payStartTime,jdbcType=TIMESTAMP},
            </if>
            <if test="payEndTime != null">
                pay_end_time = #{payEndTime,jdbcType=TIMESTAMP},
            </if>
            <if test="payEndTimeOld != null">
                pay_end_time_old = #{payEndTimeOld,jdbcType=TIMESTAMP},
            </if>
            <if test="adminAddTime != null">
                admin_add_time = #{adminAddTime,jdbcType=TIMESTAMP},
            </if>
            <if test="totalHours != null">
                total_hours = #{totalHours,jdbcType=DECIMAL},
            </if>
            <if test="totalMonth != null">
                total_month = #{totalMonth,jdbcType=INTEGER},
            </if>
            <if test="isMember != null">
                is_member = #{isMember,jdbcType=VARCHAR},
            </if>
            <if test="miniProgramCoverImgUrl != null">
                mini_program_cover_img_url = #{miniProgramCoverImgUrl,jdbcType=VARCHAR},
            </if>
            <if test="insertTime != null">
                insert_time = #{insertTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="insertAdmin != null">
                insert_admin = #{insertAdmin,jdbcType=INTEGER},
            </if>
            <if test="updateAdmin != null">
                update_admin = #{updateAdmin,jdbcType=INTEGER},
            </if>
            <if test="versions != null">
                versions = #{versions,jdbcType=INTEGER},
            </if>
            <if test="del != null">
                del = #{del,jdbcType=CHAR},
            </if>
            <if test="remark != null">
                remark = #{remark,jdbcType=VARCHAR},
            </if>
            <if test="memberState != null">
                member_state = #{memberState,jdbcType=INTEGER},
            </if>
            <if test="fkSysJobWxId != null">
                fk_sys_job_wx_id = #{fkSysJobWxId,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    <!--改变店铺状态-->
    <update id="changeShopState">
        UPDATE shp_shop SET fk_shp_state_code = #{state},update_time = now() WHERE id = #{shopId}
    </update>
    <update id="updateShopMember">
        update shp_shop set is_member = #{yesOrNo}, update_time = now() where id = #{shopId}
    </update>


    <select id="listMemShop" parameterType="com.luxuryadmin.param.mem.ParamMemShop"
            resultType="com.luxuryadmin.vo.mem.VoMemShop">
        SELECT
        ss.id AS shopId
        ,ss.number AS shopNumber
        ,ss.name AS shopName
        ,"年费会员" AS memberType
        ,ss.contact AS phone
        ,CONCAT_WS("/",suf.nickname,suf.id) AS fkInviteUser
        ,ss.pay_start_time AS payStartTime
        ,ss.fk_shp_state_code AS fkShpStateCode
        ,CASE
        WHEN ss.pay_end_time <![CDATA[>]]> now() and ss.pay_start_time <![CDATA[<]]> now() and ss.fk_shp_state_code
        <![CDATA[>]]> 0 THEN 1
        WHEN ss.pay_end_time <![CDATA[<]]> now() and ss.fk_shp_state_code <![CDATA[>]]> 0 THEN 3
        ELSE
        2
        END as memberShopState
        FROM
        shp_shop ss
        LEFT JOIN shp_user_invite sui
        ON ss.fk_shp_user_id = sui.fk_be_invite_user_id
        LEFT JOIN shp_user suf
        ON suf.id = sui.fk_invite_user_id
        WHERE is_member = 'yes' and member_state>=2
        <if test="number != null">
            and ss.number like CONCAT('%',#{number},'%')
        </if>
        <if test="phone != null">
            and ss.contact like CONCAT('%',#{phone},'%')
        </if>
        <if test="name != null">
            and ss.name like CONCAT('%',#{name},'%')
        </if>
        <if test="memberShopState != null and memberShopState == 1">
            and (ss.pay_end_time <![CDATA[>]]> now() and ss.pay_start_time <![CDATA[<]]> now() and ss.fk_shp_state_code
            <![CDATA[>]]> 0)
        </if>
        <if test="memberShopState != null and memberShopState == 2">
            and ss.fk_shp_state_code <![CDATA[<]]> 0
        </if>
        <if test="memberShopState != null and memberShopState == 3">
            and (ss.pay_end_time <![CDATA[<]]> now() and ss.fk_shp_state_code <![CDATA[>]]> 0)
        </if>
        <if test="startTimeStart != null">
            and ss.pay_start_time <![CDATA[>=]]> #{startTimeStart}
        </if>
        <if test="startTimeEnd != null">
            and #{startTimeEnd} <![CDATA[>=]]> ss.pay_start_time
        </if>
        <if test="fkInviteUser != null and fkInviteUser != ''">
            and (suf.id like CONCAT('%',#{fkInviteUser},'%') or suf.nickname like CONCAT('%',#{fkInviteUser},'%'))
        </if>
        and ss.del = '0'
        order by ss.pay_start_time desc
    </select>

    <select id="getVoMemShopById"
            resultType="com.luxuryadmin.vo.mem.VoMemShopById">
        SELECT
        ss.id AS shopId
        ,ss.number AS shopNumber
        ,ss.name AS shopName
        ,ss.remark AS remark
        ,ss.contact AS phone
        ,ss.id AS leaguerCount
        ,ss.pay_end_time AS payEndTime
        ,ss.fk_shp_user_id AS userId
        ,su.nickname AS nickname
        ,ss.fk_shp_state_code AS fkShpStateCode
        FROM
        shp_shop ss
        LEFT JOIN shp_user su
        ON su.id = ss.fk_shp_user_id
        LEFT JOIN shp_user_invite sui
        ON ss.fk_shp_user_id = sui.fk_be_invite_user_id
        LEFT JOIN shp_user suf
        ON suf.id = sui.fk_invite_user_id
        WHERE
         ss.del = '0' and ss.id  = #{shopId}
         limit 1
    </select>

    <!--获取我邀请的人的店铺信息-->
    <select id="listInviteShop" resultType="com.luxuryadmin.vo.shp.VoInviteShop">
        select
          su.`username`,
          su.`nickname`,
          su.`head_img_url` 'userHeadImgUrl',
          su.`insert_time` 'userInsertTime',
          shp.`member_state` 'memberState',
          shp.`name` 'shopName',
          shp.`insert_time` 'shopInsertTime',
          shp.`head_img_url` 'shopHeadImgUrl',
          shp.`pay_start_time` 'shopPayStartTime'
        from
          shp_user su
          left join shp_shop shp
            on su.id = shp.fk_shp_user_id
        where su.`id` in (${userIds})
        <if test="time != null">
            and DATE_FORMAT(shp.`insert_time`,'%Y-%m') = DATE_FORMAT(#{time},'%Y-%m')
        </if>
        order by shp.`member_state` desc, shp.id desc,su.id desc
    </select>


    <!--统计我邀请的人的店铺数量-->
    <select id="countInviteShop" resultType="java.util.Map">
        select
          shp.`member_state` 'memberState',
          count(shp.id) 'num'
        from
          shp_user su
          left join shp_shop shp
            on su.id = shp.fk_shp_user_id
        where su.`id` in (${userIds})
        <if test="time != null">
            and DATE_FORMAT(shp.`insert_time`,'%Y-%m') = DATE_FORMAT(#{time},'%Y-%m')
        </if>
        group by shp.`member_state`
    </select>

    <!-- 当前用户是否已经注册了同名的店铺-->
    <select id="existsShopName" resultType="java.lang.Integer">
        select
          count(*)
        from
          shp_shop
        where name = #{shopName} and fk_shp_user_id = #{userId}
        and fk_shp_state_code>0
    </select>
    <!--当前用户是否已经注册了同名的店铺,除了当前登录的店铺名称之后-->
    <select id="existsShopNameExceptOwn" resultType="java.lang.Integer">
        select
          count(*)
        from
          shp_shop
        where name = #{shopName} and fk_shp_user_id = #{userId}
        and id !=#{shopId}
    </select>

    <!--统计属于自己店铺的总数(自己是经营者)-->
    <select id="countOwnShopCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM shp_shop WHERE fk_shp_user_id = #{userId}
    </select>
    <select id="getShpShopInfoByNumber" resultType="com.luxuryadmin.vo.shp.VoShopInfo"
            parameterType="com.luxuryadmin.param.shp.ParamGetShopInfoByNumber">
        SELECT
            ss.id AS id,
            ss.NAME AS NAME,
            ss.contact AS contact,
            sd.province AS province,
            sd.city AS city
        FROM
            shp_shop ss
            LEFT JOIN shp_detail sd ON ss.id = sd.fk_shp_shop_id
        WHERE
            ss.del = 0
            AND ss.number = #{number}
    </select>
    <select id="getRegisterShopCount" resultType="java.lang.Integer" parameterType="java.lang.Integer">
        select count(*) from shp_shop where date(insert_time) = curdate() and  fk_sys_job_wx_id = #{jobWxId}
    </select>
    <select id="getMemShopCount" resultType="java.lang.Integer">
        select count(*) from shp_shop where  fk_sys_job_wx_id = #{jobWxId} and  member_state >=2  and is_member = 'yes'  and date(pay_start_time) = curdate()

        <if test="type != null and type == 2">
            and  30>= timestampdiff(day,insert_time,pay_start_time)
        </if>
        <if test="type != null and type == 3">
            and  100>= timestampdiff(day,insert_time,pay_start_time) >30
        </if>
        <if test="type != null and type == 4">
            and   timestampdiff(day,insert_time,pay_start_time) >100
        </if>
    </select>
    <select id="getUseShopCount" resultType="java.lang.Integer">
        select count(*) from shp_shop ss   where     ss.fk_sys_job_wx_id = #{jobWxId}
        <if test="type != null and type == 1">
            and  ss.id in (select fk_shp_shop_id  from pro_modify_record mr   where date(insert_time) = curdate() and (type = '开单' or type = '入库')   group by fk_shp_shop_id )
        </if>
        <if test="type != null and type == 2">
            and  ss.id in (select fk_shp_shop_id  from pro_modify_record mr   where date(insert_time) = curdate() and (type = '开单' or type = '入库')   group by fk_shp_shop_id )
            and 2> ss.member_state   and ss.is_member = 'no'
        </if>
        <if test="type != null and type == 3">
            and  ss.id in (select fk_shp_shop_id  from pro_modify_record mr   where 10 >= timestampdiff(day,mr.insert_time,now()) and (type = '开单' or type = '入库')   group by fk_shp_shop_id )

        </if>
        <if test="type != null and type == 4">
            and  ss.id not in (select fk_shp_shop_id  from pro_modify_record mr   where 10 >= timestampdiff(day,mr.insert_time,now()) and (type = '开单' or type = '入库')   group by fk_shp_shop_id )

        </if>
        <if test="type != null and type == 5">
            and try_end_time >now()
            and 2> ss.member_state   and ss.is_member = 'no'
        </if>
        <if test="type != null and type == 6">
            and now() >try_end_time
            and 2> ss.member_state   and ss.is_member = 'no'
        </if>
    </select>
    <select id="getShopInfo" resultMap="BaseResultMap" parameterType="java.lang.Integer">
        select <include refid="Base_Column_List"/> from
        shp_shop
        where id =#{shopId}
        and del = 0
        and is_member = 'yes'
        and member_state in (2,3)
    </select>
</mapper>